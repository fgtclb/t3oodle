<html xmlns:f="http://typo3.org/ns/TYPO3/CMS/Fluid/ViewHelpers"
      xmlns:t3oodle="http://typo3.org/ns/T3/T3oodle/ViewHelpers"
      data-namespace-typo3-fluid="true">

    <f:render partial="FormErrors" />
    <f:form action="vote" name="vote" object="{vote}" class="voting mb-5">
        <f:form.hidden property="parent" value="{poll}" />

        <div class="table-responsive">
            <table class="table table-striped table-borderless">
                <thead>
                    <f:render partial="Poll/Voting/TableHead" arguments="{poll:poll, vote:vote}" />
                </thead>
                <tbody>
                <f:if condition="{poll.settingVotingExpiresAt}">
                    <tr>
                        <td colspan="{poll.options -> f:count() -> t3oodle:math.add(number:1)}" class="text-center">
                            <strong>Achtung!</strong>
                            <f:if condition="{poll.votingExpired}">
                                <f:then>
                                    Für diese Umfrage konnte nur bis <time class="font-weight-bold text-info" datetime="{poll.settingVotingExpiresAt -> f:format.date(format:'%Y-%M-%d %H:%I')}">{poll.settingVotingExpiresAt -> f:format.date(format:'{settings.dateTimeFormat}')}</time>
                                    abgestimmt werden.
                                </f:then>
                                <f:else>
                                    Für diese Umfrage kann nur bis <time class="font-weight-bold text-info" datetime="{poll.settingVotingExpiresAt -> f:format.date(format:'%Y-%M-%d %H:%I')}">{poll.settingVotingExpiresAt -> f:format.date(format:'{settings.dateTimeFormat}')}</time> abgestimmt werden.
                                </f:else>
                            </f:if>
                        </td>
                    </tr>
                </f:if>
                <f:if condition="{poll -> t3oodle:permission(action:'seeVotesDuringVoting')}">
                    <f:then>
                        <f:if condition="{poll.settingAnonymousVoting}">
                            <tr>
                                <td colspan="{poll.options -> f:count() -> t3oodle:math.add(number:1)}" class="text-center">
                                    <span class="text-danger font-weight-bolder small">Die Abstimmung ist anonym.</span>
                                    <span class="small">Als Autor der Umfrage siehst Du die Ergebnisse dennoch.</span>
                                </td>
                            </tr>
                        </f:if>
                        <f:for each="{poll.votes}" as="pollVote">
                            <f:if condition="{settings._currentUserIdent} !== {pollVote.participantIdent}">
                                <f:render partial="Poll/Voting/VoteRow" arguments="{vote:pollVote}" />
                            </f:if>
                        </f:for>
                    </f:then>
                    <f:else>
                        <tr>
                            <td colspan="{poll.options -> f:count() -> t3oodle:math.add(number:1)}" class="text-center">
                                <span class="text-danger font-weight-bolder small">Die Abstimmung ist anonym.</span>
                            </td>
                        </tr>
                    </f:else>
                </f:if>
                <f:if condition="{poll -> t3oodle:permission(action:'voting')}">
                    <f:then>
                        <tr class="vote yours">
                            <td>
                                <div class="row">
                                    <div class="col-11">
                                        <f:if condition="{settings._currentUser}">
                                            <f:then>
                                                <f:form.hidden property="participant" />
                                                <div>{vote.participantName}</div>
                                                <div>{vote.participantMail}</div>
                                            </f:then>
                                            <f:else>
                                                <f:form.textfield property="participantName" class="form-control form-control-sm" placeholder="Dein Name" tabindex="1" />
                                                <f:form.textfield property="participantMail" class="form-control form-control-sm mt-1" placeholder="Deine E-Mail-Adresse" tabindex="2" />
                                            </f:else>
                                        </f:if>
                                    </div>
                                    <div class="col-1">
                                        <f:if condition="{vote.uid}">
                                            <f:link.action action="deleteVote" arguments="{vote:vote}"
                                                           class="t3oodle-poll-vote-remove btn btn-link btn-sm border-0 text-danger font-weight-bold float-right"
                                                           title="Remove your vote" data="{confirm:'Are you sure you want to remove your own vote?'}">
                                                x
                                            </f:link.action>
                                        </f:if>
                                    </div>
                                </div>
                            </td>
                            <f:if condition="{vote.uid}">
                                <f:then>
                                    <f:for each="{vote.optionValues}" as="optionValue" iteration="iterator" key="key">
                                        <td class="{f:if(condition:'{iterator.isEven}', then:'even', else:'odd')}">
                                            <f:render partial="Poll/VotingBox" arguments="{option:optionValue.option, key:key, value:optionValue.value}" />
                                        </td>
                                    </f:for>
                                </f:then>
                                <f:else>
                                    <f:for each="{poll.options}" as="option" iteration="iterator" key="key">
                                        <td class="{f:if(condition:'{iterator.isEven}', then:'even', else:'odd')}">
                                            <f:variable name="newOptionValue">{newOptionValues.{option.uid}}</f:variable>
                                            <f:if condition="{option.full}">
                                                <f:then>
                                                    Full
                                                </f:then>
                                                <f:else>
                                                    <f:render partial="Poll/VotingBox" arguments="{option:option, key:key, value:newOptionValue}" />
                                                </f:else>
                                            </f:if>
                                        </td>
                                    </f:for>
                                </f:else>
                            </f:if>
                        </tr>
                    </f:then>
                    <f:else>
                        <f:render partial="Poll/Voting/VoteRow" arguments="{vote:vote}" />
                    </f:else>
                </f:if>
                </tbody>
            </table>
        </div>
        <input type="hidden" name="t3oodleResourcePath" id="t3oodleResourcePath" value="{f:uri.resource(path:'')}" />
        <f:if condition="{poll.finished}">
            <f:then>
                <div class="text-center">

                    <p class="mb-1">The voting has been finished at <time class="font-weight-bold text-info" datetime="{poll.finishDate -> f:format.date(format:'%Y-%M-%d %H:%I')}">{poll.finishDate -> f:format.date(format:'{settings.dateTimeFormat}')}</time>.
                        The final option is:</p>
                    <p class="lead"><strong>{poll.finalOption.name}</strong></p>
                </div>
            </f:then>
            <f:else>
                <div class="text-right">
                    <span id="t3oodle-votes-summary"></span>
                    <f:if condition="{poll -> t3oodle:permission(action:'voting')}">
                        <f:then>
                            <f:if condition="{vote.uid}">
                                <f:then><f:form.submit class="btn btn-primary" value="Update" /></f:then>
                                <f:else><f:form.submit class="btn btn-primary" value="Vote" /></f:else>
                            </f:if>
                        </f:then>
                        <f:else>
                            <f:form.submit class="btn btn-light" value="Voting disabled" disabled="disabled" />
                        </f:else>
                    </f:if>
                </div>
            </f:else>
        </f:if>
    </f:form>

</html>
